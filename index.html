<!DOCTYPE html>
<html>
  <head>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <style></style>
  </head>

  <body>
    <h1>Asian American Hate Crimes in NYC</h1>
    <p>By: Gracie Jing (kgj7), Connie Liu (cl2264), Olivia Zhu (oz28)</p>
    <svg id="map" width="1000" height="800"></svg>

    <script>
      const svg = d3.select("svg#map");
      const width = svg.attr("width");
      const height = svg.attr("height");
      const margin = { top: 20, right: 20, bottom: 20, left:20};
      const mapWidth = width - margin.left - margin.right;
      const mapHeight = height - margin.top - margin.bottom;
      const map = svg.append("g")
                      .attr("transform","translate("+margin.left+","+margin.top+")");

      const requestData = async function () {
        // a CSV dataset of NYPD hate crimes
        let hateCrimes = await d3.csv("NYPD_Hate_Crimes.csv", d3.autoType);

        // a GeoJSON dataset of police precincts in NYC
        let precincts = await d3.json("nyc_police_precincts.json");

        // create d3 time objects
        let timeParser = d3.timeParse("%m/%d/%Y");

        const countyToBorough = {
          'QUEENS': 'Queens',
          'BRONX': 'Bronx',
          'NEW YORK': 'Manhattan',
          'KINGS': 'Brooklyn',
          'RICHMOND': 'Staten Island'
        };

        // clean up hate crime data
        hateCrimes.forEach((d) => {
          d["Arrest Date"] = timeParser(d["Arrest Date"]);
          d["Record Create Date"] = timeParser(d["Record Create Date"]);
          d["precinct"] = d["Complaint Precinct Code"]
          d["borough"] = countyToBorough[d.County]
        });

        // clean up police precincts data
        precincts.features.forEach((d) => {
          d.properties.precinct = parseInt(d.properties.policePrecinct);
        });

        console.log(hateCrimes);
        console.log(precincts);
        console.log(hateCrimes.length)

        var projection = d3.geoMercator().fitSize([width, height], precincts);
        var path = d3.geoPath().projection(projection);
        map.selectAll("path.precinct")
           .data(precincts.features)
           .join("path")
           .attr("class", "precinct")
           // .attr("fill", "blue")
           .attr("stroke", "black")
           .attr("stroke-width", 1)
           .attr("d", path);


        // Organizing data per precinct

        let precinctCrimeCount = {};
        let boroughCrimeCount = {};
        precincts.features.forEach(d => {
          console.log(d)
          precinctCrimeCount[d.properties.precinct] = 0
          boroughCrimeCount[d.properties.borough] = 0
        });
        // console.log(precinctCrimeCount)
        hateCrimes.forEach(d => {
            precinctCrimeCount[d.precinct] += 1
            boroughCrimeCount[d.borough] += 1
        });
        console.log(precinctCrimeCount)
        console.log(boroughCrimeCount)

        let colorScale = d3.scaleQuantile()
                           .domain(Object.values(precinctCrimeCount))
                           .range(["#fff", "#d1e8ed", "#adc2da", "#8879b3", "#762b80"])

        map.selectAll(".precinct")
           .style("fill", d => colorScale(precinctCrimeCount[d.properties.precinct]));

      };


      requestData();
    </script>
  </body>

</html>
